name: 'Degas Firmware Dumper'

on:
  schedule:
    # Run daily at 00:00 UTC to process backlog
    - cron: '0 0 * * *'
  
  push:
    branches:
      - main
    paths:
      - 'firmware_updates/*.json'
    tags-ignore:
      - '**'  # Prevent re-runs when tags are created
  
  workflow_dispatch:
    inputs:
      region:
        description: 'Region to process (leave empty for all)'
        required: false
        type: choice
        options:
          - ''
          - global
          - eea
          - ru
          - id
          - tw
          - tr
          - global_dc

# Prevent multiple runs of this workflow
concurrency:
  group: firmware-dumper-${{ github.ref }}
  cancel-in-progress: false

jobs:
  update_manifests:
    name: 'Update Firmware Manifests'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      
      - name: Check for Latest Firmware Updates
        run: |
          echo "ðŸ” Checking Mi Community API for firmware updates..."
          python3 .github/scripts/check_firmware_mi_community.py
      
      - name: Commit Manifest Changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if git diff --quiet firmware_updates/; then
            echo "â„¹ï¸  No manifest changes"
          else
            git add firmware_updates/
            git commit -m "ðŸ“¦ Update firmware manifests [skip ci]"
            git pull --rebase
            git push
            echo "âœ… Manifests updated"
          fi

  process_firmware_files:
    name: 'Process Firmware (${{ matrix.region }})'
    needs: update_manifests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    strategy:
      fail-fast: false  # Continue other regions if one fails
      max-parallel: 7   # Process all regions in parallel
      matrix:
        region: [global, eea, ru, id, tw, tr, global_dc]

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Cache Dependencies
        uses: actions/cache@v4
        with:
          path: |
            /var/cache/apt
            /var/lib/apt
          key: ${{ runner.os }}-apt-${{ hashFiles('**/firmware_updater.yml') }}
          restore-keys: |
            ${{ runner.os }}-apt-

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y aria2 tree pigz python3

      - name: Read Manifest and Find Next Version
        id: firmware_info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REGION: ${{ matrix.region }}
        run: |
          MANIFEST_PATH="firmware_updates/${REGION}.json"
          
          # Check if manifest exists
          if [ ! -f "$MANIFEST_PATH" ]; then
            echo "No manifest for region ${REGION}. Skipping."
            echo "DATA_FOUND=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Find next version to process
          python3 .github/scripts/find_next_version.py

      - name: Check if Release Already Exists
        if: steps.firmware_info.outputs.DATA_FOUND == 'true'
        id: check_release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="v${{ steps.firmware_info.outputs.VERSION }}-${{ matrix.region }}"
          echo "ðŸ” Double-checking tag: ${TAG}"
          if gh release view "$TAG" --json name >/dev/null 2>&1; then
            echo "âš ï¸  Release ${TAG} already exists (race condition detected). Stopping."
            echo "IS_NEW=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… Release ${TAG} is new. Proceeding with download."
            echo "IS_NEW=true" >> $GITHUB_OUTPUT
          fi

      - name: Free up disk space on runner
        if: steps.check_release.outputs.IS_NEW == 'true'
        run: |
          echo "Freeing up disk space..."
          df -h
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL \
                      /opt/hostedtoolcache/go /opt/hostedtoolcache/Python /opt/hostedtoolcache/Ruby \
                      /opt/hostedtoolcache/Java "$AGENT_TOOLSDIRECTORY" 2>/dev/null || true
          docker system prune -af 2>/dev/null || true
          sudo apt-get clean
          echo "Disk space after cleanup:"
          df -h

      - name: Download and Extract Firmware
        if: steps.check_release.outputs.IS_NEW == 'true'
        run: |
          FILENAME="${{ steps.firmware_info.outputs.FILENAME }}"
          
          echo "Downloading ${FILENAME} with aria2..."
          aria2c -x 16 -s 16 -k 1M -o "${FILENAME}" "${{ steps.firmware_info.outputs.DOWNLOAD_URL }}"
          
          echo "Calculating MD5 hash..."
          MD5_HASH=$(md5sum "${FILENAME}" | awk '{print $1}')
          echo "MD5=${MD5_HASH}" >> $GITHUB_OUTPUT
          echo "MD5: ${MD5_HASH}"
          
          echo "Extracting .tgz fastboot package..."
          mkdir -p extracted_firmware
          tar -I pigz -xvf "${FILENAME}" -C extracted_firmware
          
          echo "Handling large files..."
          find extracted_firmware -type f -size +2000M | while read -r file; do
            echo "Splitting large file: $file"
            split -b 2000M "$file" "$file.part-"
            rm -f "$file"
          done
          
          rm -f "${FILENAME}"
        id: download

      - name: Update Manifest with MD5
        if: steps.check_release.outputs.IS_NEW == 'true'
        env:
          REGION: ${{ matrix.region }}
          VERSION: ${{ steps.firmware_info.outputs.VERSION }}
          MD5: ${{ steps.download.outputs.MD5 }}
        run: |
          python3 .github/scripts/update_manifest_md5.py

      - name: Create GitHub Release and Upload Files
        if: steps.check_release.outputs.IS_NEW == 'true'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          VERSION="${{ steps.firmware_info.outputs.VERSION }}"
          REGION_UPPER=$(echo "${{ matrix.region }}" | tr 'a-z' 'A-Z')
          TAG="v${VERSION}-${{ matrix.region }}"
          
          tree -F extracted_firmware > extracted_firmware/file_structure.txt
          
          TOTAL_SIZE=$(du -sh extracted_firmware | awk '{print $1}')
          FILE_COUNT=$(find extracted_firmware -type f | wc -l)
          DUMP_DATE=$(date -u +"%Y-%m-%d %H:%M:%S UTC")

          RELEASE_NOTES=$(cat <<EOF
          ## ðŸ“¦ Firmware Information
          
          - **Version:** ${VERSION}
          - **Region:** ${REGION_UPPER}
          - **HyperOS Version:** ${{ steps.firmware_info.outputs.HYPEROS_VERSION }}
          - **Android Version:** ${{ steps.firmware_info.outputs.ANDROID_VERSION }}
          - **Release Date:** ${{ steps.firmware_info.outputs.RELEASE_DATE }}
          - **MD5 Hash:** \`${{ steps.download.outputs.MD5 }}\`
          
          ## ðŸ“Š Package Details
          
          - **Total Size:** ${TOTAL_SIZE}
          - **File Count:** ${FILE_COUNT}
          - **Dump Date:** ${DUMP_DATE}
          - **Codename:** degas (Xiaomi 14T)
          
          ## ðŸ”— Source
          
          Downloaded from: ${{ steps.firmware_info.outputs.DOWNLOAD_URL }}
          
          ---
          
          ðŸ“„ A complete file list and directory structure is available in the \`file_structure.txt\` asset attached below.
          EOF
          )

          echo "Creating release with tag: ${TAG}"
          gh release create "$TAG" \
            --title "ðŸš€ ${VERSION} [${REGION_UPPER}]" \
            --notes "$RELEASE_NOTES" \
            $(find extracted_firmware -type f)

      - name: Commit Updated Manifest
        if: steps.check_release.outputs.IS_NEW == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Pull latest changes first to avoid conflicts with parallel jobs
          git pull --rebase origin main || true
          
          git add firmware_updates/${{ matrix.region }}.json
          if git diff --staged --quiet; then
            echo "â„¹ï¸  No changes to commit"
            exit 0
          fi
          
          git commit -m "Update ${{ matrix.region }} manifest with MD5 for ${{ steps.firmware_info.outputs.VERSION }} [skip ci]"
          
          # Retry push up to 3 times in case of parallel push conflicts
          for i in {1..3}; do
            if git push; then
              echo "âœ… Manifest pushed successfully"
              break
            else
              echo "âš ï¸  Push failed, attempt $i/3"
              if [ $i -lt 3 ]; then
                sleep $((5 + RANDOM % 10))  # Random delay 5-15 seconds
                git pull --rebase origin main
              else
                echo "âŒ Failed to push after 3 attempts"
                exit 1
              fi
            fi
          done

  update_readme:
    needs: process_firmware_files
    runs-on: ubuntu-latest
    if: success() || failure()
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Update Firmware Index in README
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3 .github/scripts/update_firmware_index.py

      - name: Commit and Push README Changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Check if there are changes
          if git diff --quiet README.md; then
            echo "â„¹ï¸  No changes to README.md"
            exit 0
          fi
          
          # Stash any other changes to avoid conflicts
          git stash --include-untracked || true
          
          # Commit README changes
          git add README.md
          git commit -m "ðŸ“ Update firmware index [skip ci]" || exit 0
          
          # Retry push up to 3 times in case of parallel push conflicts
          for i in {1..3}; do
            if git push origin main; then
              echo "âœ… README.md updated and pushed"
              break
            else
              echo "âš ï¸  Push failed, attempt $i/3"
              if [ $i -lt 3 ]; then
                sleep $((5 + RANDOM % 10))  # Random delay 5-15 seconds
                git pull --rebase origin main || true
              else
                echo "âŒ Failed to push README.md after 3 attempts"
                exit 1
              fi
            fi
          done
